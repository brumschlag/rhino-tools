<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="BuildAll" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup Condition="!Exists('$(Configuration)')">
		<SharedLibsDir>$(MSBuildProjectDirectory)\..\SharedLibs</SharedLibsDir>
		<Configuration>Debug</Configuration>
		<EnableTest>True</EnableTest>
		<OutputDir>$(MSBuildProjectDirectory)</OutputDir>
		<LogsDir>$(MSBuildProjectDirectory)</LogsDir>
		<KeyFile>$(MSBuildProjectDirectory)\..\ayende-open-source.snk</KeyFile>
		<ClsCompliant Condition="'$(ClsCompliant)' == ''">true</ClsCompliant>
		<OutDir>$(MSBuildProjectDirectory)\..\Build\$(ProjectName)\</OutDir>
		<ArtifactssDir>$(MSBuildProjectDirectory)\..\Artifacts</ArtifactssDir>
	</PropertyGroup>

	<Target Name="BuildAll"
			DependsOnTargets="Clean;BeforeCompile;Compile;BeforeTest;UnitTest;BeforeZip;Zip;Upload;" />

	<Target Name="BeforeCompile"/>
	<Target Name="BeforeTest"/>
	<Target Name="BeforeZip"/>
	
	<Target Name="Clean">
		<MSBuild Projects="$(SolutionFile)"
				 Properties="Configuration=$(Configuration);OutDir=$(OutDir);OutputPath=$(OutDir)"
				 Targets="Clean" />
	</Target>
	<Target Name="GenerateAssemblyInfo">
		<SvnVersion LocalPath="." ToolPath="$(SharedLibsDir)\Tools\Subversion">
			<Output TaskParameter="Revision"
					PropertyName="Revision" />
		</SvnVersion>
		<AssemblyInfo AssemblyCompany ="Rhino"
			AssemblyCopyright="Oren Eini (c) 2006 - 2008"
			AssemblyDescription="$(ProjectName)"
			AssemblyInformationalVersion="$(Version).$(Revision)"
			 AssemblyTitle ="$(ProjectName)$(ExtraInfo)"
			 CodeLanguage="CS"
			 CLSCompliant ="$(ClsCompliant)"
			 AssemblyVersion ="$(Version).$(Revision)"
			 OutputFile="%(AssemblyInfo.File)"
			 />
	</Target>
	
	<Target Name="Compile" DependsOnTargets="GenerateAssemblyInfo">
		
		<MSBuild Projects="$(SolutionFile)"
				 Properties="Configuration=$(Configuration);
				 OutDir=$(OutDir);
				 OutputPath=$(OutDir);
				 ArtifactssDir=$(ArtifactssDir);
				 TreatWarningsAsErrors=True" />
	</Target>

	<ItemGroup>
		<ExistingZipFiles Include="$(ArtifactssDir)\$(ProjectName)*.zip"/>
	</ItemGroup>

	<Target Name="Zip">
		<Delete Files="@(ExistingZipFiles)"/>
		<Time Format="yyyy-MMM-dd-HH-mm">
			<Output TaskParameter="FormattedTime"
					PropertyName="buildDate" />
		</Time>
		<SvnVersion LocalPath="." ToolPath="$(SharedLibsDir)\Tools\Subversion">
			<Output TaskParameter="Revision"
					PropertyName="Revision" />
		</SvnVersion>
		<CreateProperty value="$(ArtifactssDir)\$(ProjectName)-@$(Revision)-$(Configuration)-$(buildDate).zip">
			<Output TaskParameter="Value"
					PropertyName="ZipFileName" />
		</CreateProperty>
		<Zip Files="@(ZipFiles)" Flatten="$(FlattenZipFile)" ZipLevel="9"
		    WorkingDirectory="$(MSBuildProjectDirectory)"
			 ZipFileName="$(ZipFileName)" />
	</Target>
	
	<Target Name="UnitTest" Condition="$(EnableTest)">
		<MbUnit Assemblies="@(TestAssembly)" 
			ReportFileNameFormat="MbUnit.Results" 
			ReportTypes ="html; xml"  
			ReportOutputDirectory="$(OutDir)TestResults" />
	</Target>
	
	<Target Name="Upload" Condition="$(FtpUsername) != ''">
		<Time Format="dd MMM yyyy HH:mm">
			<Output TaskParameter="FormattedTime"
					PropertyName="humanDate" />
		</Time>
		 <FtpUpload 
                LocalFile="$(ZipFileName)" 
                Username ="$(FtpUsername)"
                Password="$(FtpPassword)"
                RemoteUri="ftp://ftp.ayende.com/wwwroot/Builds/$(ShortName)/Nightlies/$(ZipFileName)" />
          <Exec 
			Command='$(SharedLibsDir)\Tools\RegisterFile\registerFile "$(WebUser)" "$(WebPass)" $(SectionId) "$(ProjectName) Nightly Build For Revision $(Revision) @ $(humanDate)" "application/x-zip" C:\domains\ayende.com\wwwroot\Builds\$(ShortName)\Nightlies\$(ZipFileName)'/>
	</Target>
	<Import Project="$(SharedLibsDir)\Tools\MSBuild.Community.Tasks.Targets"/>
	<UsingTask TaskName="MbUnit.MSBuild.Tasks.MbUnit"  AssemblyFile="$(SharedLibsDir)\Tools\MbUnit\MbUnit.MSBuild.Tasks.dll" />
</Project>